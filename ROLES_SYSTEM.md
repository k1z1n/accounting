# Система ролей пользователей

## Описание

Реализована расширенная система ролей пользователей с ограничениями доступа к платформам в зависимости от роли.

## Доступные роли

### 1. Администратор (`admin`)
- **Доступ**: Все платформы (Бухгалтерия + Статистика)
- **Права**: Полный доступ ко всем функциям системы
- **Дополнительно**: Доступ к админ-панели, управление пользователями

### 2. Бухгалтер (`accountant`)
- **Доступ**: Только платформа "Бухгалтерия"
- **Права**: Работа с заявками, операциями, валютами
- **Ограничения**: Нет доступа к статистике и админ-функциям

### 3. Статистик (`statistician`)
- **Доступ**: Только платформа "Статистика"
- **Права**: Просмотр аналитики, графиков, отчетов
- **Ограничения**: Нет доступа к бухгалтерии и редактированию данных

### 4. Пользователь (`user`)
- **Доступ**: Все платформы (Бухгалтерия + Статистика)
- **Права**: Базовые функции в рамках доступных платформ
- **Ограничения**: Нет доступа к админ-функциям

## Логика работы

### Автоматический выбор платформы
- Если у пользователя доступ только к одной платформе, она выбирается автоматически
- Бухгалтер при входе сразу попадает в "Бухгалтерию"
- Статистик при входе сразу попадает в "Статистику"

### Проверки безопасности
- Middleware `CheckPlatform` проверяет права доступа к выбранной платформе
- При попытке доступа к недоступной платформе пользователь перенаправляется на выбор
- Сессии с недопустимыми платформами автоматически очищаются

### Ограничения в интерфейсе
- Админские функции доступны только администраторам
- Меню платформ показывает только доступные варианты
- Индикатор роли отображается на странице выбора платформы

## Тестовые пользователи

После запуска `php artisan db:seed --class=UserRolesSeeder` создаются:

```
admin / admin123 - Администратор (все платформы)
accountant / accountant123 - Бухгалтер (только Бухгалтерия)
statistician / statistician123 - Статистик (только Статистика)
user1 / user123 - Пользователь (все платформы)
user2 / user123 - Пользователь (все платформы)
```

## Технические детали

### Модель User
Добавлены константы ролей и методы:
- `ROLE_ADMIN`, `ROLE_ACCOUNTANT`, `ROLE_STATISTICIAN`, `ROLE_USER`
- `isAdmin()`, `isAccountant()`, `isStatistician()`
- `getAvailablePlatforms()` - возвращает доступные платформы
- `hasAccessToPlatform($platform)` - проверяет доступ к платформе

### Платформа "Статистика"
- Новый контроллер `StatisticsController`
- Страница с аналитикой и графиками
- API для получения данных графиков
- Маршрут `/statistics`

### Миграция
- Обновлен enum поля `role` в таблице `users`
- Добавлены новые роли: `accountant`, `statistician`

## Сценарии использования

### Сценарий 1: Вход бухгалтера
1. Пользователь входит с ролью "бухгалтер"
2. Система автоматически выбирает платформу "Бухгалтерия"
3. Пользователь попадает на главную страницу бухгалтерии
4. В меню нет опций статистики или админ-функций

### Сценарий 2: Вход статистика
1. Пользователь входит с ролью "статистик"
2. Система автоматически выбирает платформу "Статистика"
3. Пользователь попадает на страницу аналитики
4. Доступны только функции просмотра статистики

### Сценарий 3: Вход администратора
1. Пользователь входит с ролью "администратор"
2. Появляется страница выбора платформы
3. Доступны обе платформы
4. В меню есть все админские функции

### Сценарий 4: Попытка несанкционированного доступа
1. Бухгалтер пытается перейти на `/statistics`
2. Middleware обнаруживает нарушение
3. Сессия очищается
4. Пользователь перенаправляется на выбор платформы с ошибкой

## Расширение системы

### Добавление новой роли
1. Добавить константу в модель `User`
2. Обновить миграцию для добавления роли в enum
3. Добавить логику доступа в `getAvailablePlatforms()`
4. Обновить методы проверки ролей
5. Добавить в seeder при необходимости

### Добавление новой платформы
1. Добавить платформу в `PlatformSelectionController::PLATFORMS`
2. Обновить логику доступа в модели `User`
3. Создать соответствующие контроллеры и представления
4. Добавить маршруты

## Безопасность

- Все проверки ролей основаны на серверной логике
- Middleware проверяет доступ на каждом запросе
- Нет возможности обойти ограничения через фронтенд
- Сессии автоматически очищаются при нарушениях

## Мониторинг

Рекомендуется логировать:
- Попытки несанкционированного доступа
- Смену платформ пользователями
- Действия администраторов 

# Настройка фоновой синхронизации заявок

## Проблема
Ранее при загрузке главной страницы происходила блокирующая синхронизация с внешними источниками (obama.ru и ural-obmen.ru), что значительно замедляло загрузку страницы.

## Решение
Синхронизация вынесена в фоновый режим с использованием Laravel Queue.

## Компоненты

### 1. Job для синхронизации
- **Файл**: `app/Jobs/SyncApplicationsJob.php`
- **Назначение**: Выполняет синхронизацию в фоновом режиме

### 2. Команда для ручного запуска
- **Файл**: `app/Console/Commands/SyncApplicationsCommand.php`
- **Использование**: `php artisan applications:sync {page}`

### 3. Скрипты для управления воркером
- **Запуск**: `./start-queue-worker.sh`
- **Остановка**: `./stop-queue-worker.sh`

## Настройка

### 1. Запуск воркера очереди
```bash
# Запустить воркер в фоновом режиме
./start-queue-worker.sh

# Или вручную
php artisan queue:work --daemon --sleep=3 --tries=3
```

### 2. Проверка статуса
```bash
# Проверить, что воркер работает
ps aux | grep "queue:work"

# Посмотреть логи
tail -f storage/logs/laravel.log
```

### 3. Остановка воркера
```bash
./stop-queue-worker.sh
```

## API Endpoints

### Ручной запуск синхронизации
- **URL**: `/api/sync-applications`
- **Метод**: GET
- **Параметры**: `page` (опционально, по умолчанию 1)
- **Ответ**: JSON с статусом операции

### Пример использования
```javascript
fetch('/api/sync-applications?page=1')
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('Синхронизация запущена');
    }
  });
```

## Автоматический запуск

### При загрузке главной страницы
Синхронизация автоматически запускается в фоне при загрузке главной страницы и при запросе дополнительных данных через AJAX.

### При запросе дополнительных данных
При нажатии "Загрузить ещё" также запускается фоновая синхронизация.

## Мониторинг

### Просмотр очереди
```bash
# Посмотреть количество задач в очереди
php artisan queue:size

# Посмотреть неудачные задачи
php artisan queue:failed
```

### Логирование
Все операции синхронизации логируются в `storage/logs/laravel.log` с тегами:
- `Запуск фоновой синхронизации заявок`
- `Фоновая синхронизация заявок завершена`
- `Ошибка фоновой синхронизации заявок`

## Преимущества

1. **Быстрая загрузка страницы** - страница загружается мгновенно
2. **Неблокирующие запросы** - пользователь не ждет завершения синхронизации
3. **Надежность** - автоматические повторы при ошибках
4. **Масштабируемость** - можно запускать несколько воркеров

## Troubleshooting

### Воркер не запускается
1. Проверьте, что таблица `jobs` существует: `php artisan migrate`
2. Проверьте права доступа к файлам логов
3. Убедитесь, что PHP имеет права на выполнение

### Синхронизация не работает
1. Проверьте логи: `tail -f storage/logs/laravel.log`
2. Убедитесь, что воркер запущен: `ps aux | grep "queue:work"`
3. Проверьте конфигурацию обменников в `config/exchanger.php`

### Очередь переполняется
1. Увеличьте количество воркеров
2. Проверьте настройки таймаутов
3. Добавьте мониторинг очереди 

 
 
 
 
 
 
 
 
 
 
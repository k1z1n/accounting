# Автоматическое управление куки обменников

## Обзор

Система автоматического управления куки позволяет получать свежие куки для обменников obama.ru и ural-obmen.ru без ручного вмешательства. Система включает в себя:

- Автоматическое решение CAPTCHA
- Кэширование куки на 1 час
- Валидация куки перед использованием
- Автоматическое обновление при истечении срока

## Настройка

### 1. Добавьте учетные данные в .env файл

```env
# Obama.ru
OBAMA_USERNAME=your_username
OBAMA_PASSWORD=your_password
OBAMA_PIN=your_pin_code
OBAMA_COOKIE=

# Ural-obmen.ru
URAL_USERNAME=your_username
URAL_PASSWORD=your_password
URAL_PIN=your_pin_code
URAL_COOKIE=
```

### 2. Убедитесь, что установлены необходимые расширения PHP

```bash
# Для работы с изображениями CAPTCHA
sudo apt-get install php-gd
# или для macOS
brew install php@8.1
```

## Использование

### Команды управления куки

```bash
# Показать статус всех обменников
php artisan cookies:manage status

# Показать статус конкретного обменника
php artisan cookies:manage status obama

# Обновить куки для всех обменников
php artisan cookies:manage refresh

# Обновить куки для конкретного обменника
php artisan cookies:manage refresh obama

# Протестировать куки
php artisan cookies:manage test

# Протестировать CAPTCHA для конкретного обменника
php artisan test:captcha obama
```

### Автоматическое использование в коде

```php
use App\Services\CookieManagerService;

$cookieManager = new CookieManagerService();

// Получить свежие куки для obama
$cookies = $cookieManager->getFreshCookies('obama');

// Получить свежие куки для ural
$cookies = $cookieManager->getFreshCookies('ural');
```

## Как работает система

### 1. Получение страницы логина
Система загружает страницу логина и извлекает:
- Salt значение для безопасности
- URL изображений CAPTCHA
- Математическую операцию (+, -, *, /)

### 2. Решение CAPTCHA
Система:
- Загружает изображения CAPTCHA
- Анализирует пиксели для распознавания цифр
- Выполняет математическую операцию
- Возвращает результат

### 3. Выполнение логина
Система отправляет POST запрос с:
- Логин и пароль
- PIN код (если настроен)
- Результат CAPTCHA
- Salt значение

### 4. Кэширование
Успешные куки кэшируются на 1 час для избежания повторных логинов.

## Ограничения

### CAPTCHA распознавание
Текущая реализация использует простой алгоритм анализа пикселей. Для повышения точности рекомендуется:

1. **Настройка порогов**: Отредактируйте пороги в методе `recognizeNumber()` под конкретные CAPTCHA
2. **Внешний OCR сервис**: Интегрируйте внешний сервис OCR (например, Tesseract)
3. **Машинное обучение**: Обучите модель на примерах CAPTCHA

### Безопасность
- Учетные данные хранятся в .env файле
- Куки кэшируются локально
- Логи содержат минимальную информацию

## Устранение неполадок

### Ошибка "Не удалось распознать числа в CAPTCHA"
1. Проверьте доступность сайта
2. Убедитесь, что установлено расширение GD
3. Настройте пороги распознавания в методе `recognizeNumber()`

### Ошибка "Логин не удался"
1. Проверьте правильность учетных данных
2. Убедитесь, что PIN код указан правильно
3. Проверьте, что сайт не изменил форму логина

### Ошибка "Не удалось загрузить изображения CAPTCHA"
1. Проверьте интернет соединение
2. Убедитесь, что сайт доступен
3. Проверьте, что URL изображений не изменился

## Мониторинг

Система ведет подробные логи в `storage/logs/laravel.log`:

```
[2024-01-15 10:30:00] local.INFO: CAPTCHA решена: 5 + 3 = 8
[2024-01-15 10:30:01] local.INFO: Получены новые куки для obama
[2024-01-15 10:30:02] local.INFO: Используем кэшированные куки для ural
```

## Обновления

При изменении системы аутентификации на сайтах обменников может потребоваться обновление:

1. URL страниц логина
2. Поля формы
3. Алгоритма распознавания CAPTCHA
4. Логики валидации куки 

 
 
 
 
 
 
 
 
 
 